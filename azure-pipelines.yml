trigger:
  - master

pool: 'Default'

variables:
  imageRepository: 'test-repository'
  dockerfilePath: 'Dockerfile'
  azureContainerRegistryServiceConnection: MyACRServiceConnection
  azureServiceConnection: MyAzureServiceConnection
  containerAppName: 'test-repository'
  resourceGroup: 'test-rg-1'
  acrName: 'testacrdev1'
  tag: $(Build.BuildNumber)
  imageName: test-repository

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build job
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(azureContainerRegistryServiceConnection)
              tags: |
                $(tag)

  - stage: Deploy
    displayName: Deploy to DEV
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: Create or Update Container App
        steps:
          - task: AzureContainerApps@1
            inputs:
              azureSubscription: $(azureServiceConnection)
              resourceGroup: $(resourceGroup)
              containerAppName: $(containerAppName)
              containerAppEnvironment: development
              imageToDeploy: $(acrName).azurecr.io/$(imageName):$(tag)
              registryServer: $(acrName).azurecr.io
              registryUsername: $(ACR_USERNAME)
              registryPassword: $(ACR_PASSWORD)
      - stage: Deploy
        dependsOn: Build
        jobs:
          - job: Deploy
            steps:
              - task: AzureCLI@2
                displayName: Deploy
                inputs:
                  azureSubscription: MyAzureServiceConnection
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az deployment group create \
                      --resource-group $(resourceGroup) \
                      --template-file infra/main.bicep \
                      --parameters \
                          containerAppName=$(containerAppName) \
                          containerAppEnvName=development \
                          acrName=$(acrName) \
                          imageName=$(imageName) \
                          imageTag=$(tag)