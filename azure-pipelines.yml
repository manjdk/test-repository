trigger:
  - master

pool: 'Default'

variables:
  imageRepository: 'test-repository'
  dockerfilePath: 'Dockerfile'
  azureContainerRegistryServiceConnection: MyACRServiceConnection
  azureServiceConnection: MyAzureServiceConnection
  containerAppName: 'test-repository'
  resourceGroup: 'test-rg-1'
  acrName: 'testacrdev1'
  tag: $(Build.BuildNumber)
  imageName: test-repository

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build job
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(azureContainerRegistryServiceConnection)
              tags: |
                $(tag)

  - stage: Deploy
    displayName: Deploy to DEV
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: Create or Update Container App
        steps:
          - task: AzureCLI@2
            displayName: Ensure ACA exists + AcrPull assigned
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |

                echo "Checking if Container App exists..."

                APP_EXISTS=$(az containerapp show \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --query name \
                  --output tsv 2>/dev/null || echo "notfound")

                if [ "$APP_EXISTS" = "notfound" ]; then

                  echo "Container App not found → creating..."

                  az containerapp create \
                    --name $(containerAppName) \
                    --resource-group $(resourceGroup) \
                    --environment development \
                    --image mcr.microsoft.com/azuredocs/containerapps-helloworld:latest \
                    --target-port 80 \
                    --ingress external \
                    --system-assigned

                  echo "Getting Managed Identity..."

                  APP_ID=$(az containerapp show \
                    --name $(containerAppName) \
                    --resource-group $(resourceGroup) \
                    --query identity.principalId \
                    --output tsv)

                  ACR_ID=$(az acr show \
                    --name $(acrName) \
                    --query id \
                    --output tsv)

                  echo "Assigning AcrPull role..."

                  az role assignment create \
                    --assignee $APP_ID \
                    --scope $ACR_ID \
                    --role AcrPull

                  echo "Waiting for RBAC propagation..."
                  sleep 45

                else
                  echo "Container App already exists ✔"
                fi
          - task: AzureContainerApps@1
            displayName: Deploy to Azure Container Apps
            inputs:
              azureSubscription: $(azureServiceConnection)
              resourceGroup: $(resourceGroup)
              containerAppName: $(containerAppName)
              containerAppEnvironment: development
              imageToDeploy: $(acrName).azurecr.io/$(imageName):$(tag)
              registryIdentity: system
              targetPort: 80
              ingress: external
#    jobs:
##      - job: Deploy
#        displayName: Create or Update Container App
#        steps:
#          - script: |
#              echo "ACR Name: $(acrName)"
#              echo "Image Name: $(imageName)"
#              echo "Tag: $(tag)"
#              echo "Full Image: $(acrName).azurecr.io/$(imageName):$(tag)"
#            displayName: 'Debug: Print Container App Variables'
#
#          - task: AzureCLI@2
#            inputs:
#              azureSubscription: $(azureServiceConnection)
#              scriptType: 'bash'
#              scriptLocation: 'inlineScript'
#              inlineScript: |
#                az acr repository show-tags --name $(acrName) --repository $(imageName) --output table
#            displayName: 'Verify image exists in ACR'
#
#          - task: AzureContainerApps@1
#            displayName: Deploy to Azure Container Apps
#            inputs:
#              azureSubscription: $(azureServiceConnection)
#              resourceGroup: $(resourceGroup)
#              containerAppName: $(containerAppName)
#              containerAppEnvironment: development
#              imageToDeploy: $(acrName).azurecr.io/$(imageName):$(tag)
#              targetPort: 80
#              ingress: external
#              registryIdentity: system
#              systemAssignedIdentity: true


#  - stage: Deploy
#    displayName: Deploy to DEV
#    dependsOn: Build
#    condition: succeeded()
#    jobs:
#      - job: Deploy
#        displayName: Deploy Azure Container App
#        steps:
#
#          - script: |
#              echo "ACR Name: $(acrName)"
#              echo "Image Name: $(imageName)"
#              echo "Tag: $(tag)"
#              echo "Full Image: $(acrName).azurecr.io/$(imageName):$(tag)"
#            displayName: 'Debug: Print Container App Variables'
#
#          - task: AzureCLI@2
#            inputs:
#              azureSubscription: $(azureServiceConnection)
#              scriptType: 'bash'
#              scriptLocation: 'inlineScript'
#              inlineScript: |
#                az acr repository show-tags --name $(acrName) --repository $(imageName) --output table
#            displayName: 'Verify image exists in ACR'
#
#          - task: AzureCLI@2
#            displayName: 'Create or Update Azure Container App'
#            inputs:
#              azureSubscription: $(azureServiceConnection)
#              scriptType: bash
#              scriptLocation: inlineScript
#              inlineScript: |
#                set -e
#
#                APP_EXISTS=$(az containerapp show \
#                  --name $(containerAppName) \
#                  --resource-group $(resourceGroup) \
#                  --query "name" -o tsv || echo "")
#
#                if [ -z "$APP_EXISTS" ]; then
#                  echo "Container App does not exist — creating..."
#                  az containerapp create \
#                    --name $(containerAppName) \
#                    --resource-group $(resourceGroup) \
#                    --environment $(containerAppEnvironment) \
#                    --image $(acrName).azurecr.io/$(imageName):$(tag) \
#                    --ingress external \
#                    --target-port 80 \
#                    --registry-server $(acrName).azurecr.io \
#                    --registry-username $(acrUsername) \
#                    --registry-password $(acrPassword)
#
#                  # Enable system-assigned identity
#                  az containerapp identity assign \
#                    --name $(containerAppName) \
#                    --resource-group $(resourceGroup)
#
#                  echo "First-time deploy complete. Please assign AcrPull role on ACR to system identity for future deployments."
#
#                else
#                  echo "Container App exists — updating image..."
#                  az containerapp update \
#                    --name $(containerAppName) \
#                    --resource-group $(resourceGroup) \
#                    --image $(acrName).azurecr.io/$(imageName):$(tag)
#                fi